name: Diagnostics Collection

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

jobs:
  collect-diagnostics:
    runs-on: ubuntu-latest
    
    services:
      neo4j:
        image: neo4j:5.15
        env:
          NEO4J_AUTH: neo4j/neo4j_password
          NEO4J_PLUGINS: '["apoc"]'
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "cypher-shell -u neo4j -p neo4j_password 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      qdrant:
        image: qdrant/qdrant:v1.7.4
        ports:
          - 6333:6333
        options: >-
          --health-cmd "curl -f http://localhost:6333/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build TypeScript
        run: bun run build

      - name: Generate SARIF files
        run: |
          mkdir -p diagnostics
          bun run diagnostics:tsc-sarif --output diagnostics/tsc.sarif || true
          bun run diagnostics:eslint-sarif --output diagnostics/eslint.sarif || true
          bun run diagnostics:prettier-sarif --output diagnostics/prettier.sarif || true
        continue-on-error: true

      - name: Compute config hash
        id: config
        run: |
          CONFIG_HASH=$(cat package.json bun.lock tsconfig.json | sha256sum | cut -d' ' -f1)
          echo "hash=$CONFIG_HASH" >> $GITHUB_OUTPUT

      - name: Ingest codebase
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USERNAME: neo4j
          NEO4J_PASSWORD: neo4j_password
          QDRANT_URL: http://localhost:6333
          QDRANT_COLLECTION_NAME: ping-mem-ci
          QDRANT_VECTOR_DIMENSIONS: "768"
          PING_MEM_DB_PATH: /tmp/ping-mem-ci.db
          PING_MEM_DIAGNOSTICS_DB_PATH: /tmp/ping-mem-diagnostics-ci.db
        run: |
          bun run dist/mcp/cli.js codebase_ingest --projectDir $PWD || echo "Ingestion skipped (no changes)"

      - name: Collect diagnostics
        env:
          PING_MEM_DIAGNOSTICS_DB_PATH: /tmp/ping-mem-diagnostics-ci.db
        run: |
          SARIF_FILES=""
          [ -f diagnostics/tsc.sarif ] && SARIF_FILES="diagnostics/tsc.sarif"
          [ -f diagnostics/eslint.sarif ] && SARIF_FILES="$SARIF_FILES,diagnostics/eslint.sarif"
          [ -f diagnostics/prettier.sarif ] && SARIF_FILES="$SARIF_FILES,diagnostics/prettier.sarif"
          SARIF_FILES=$(echo $SARIF_FILES | sed 's/^,//')
          
          if [ -n "$SARIF_FILES" ]; then
            bun run diagnostics:collect \
              --projectDir $PWD \
              --configHash ${{ steps.config.outputs.hash }} \
              --sarifPaths "$SARIF_FILES" \
              --environmentHash "ci-ubuntu-latest" \
              --recordWorklog
          fi

      - name: Upload diagnostics artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: diagnostics
          path: |
            diagnostics/*.sarif
            /tmp/ping-mem-diagnostics-ci.db
          retention-days: 7

      - name: Run tests
        run: bun test
